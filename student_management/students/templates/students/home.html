<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Management API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #74ebd5, #ACB6E5);
            min-height: 100vh;
        }
        h1 { color: #2c3e50; margin-top: 20px; }
        a {
            display: inline-block;
            margin: 10px 10px;
            padding: 12px 25px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: 0.3s;
        }
        a:hover { background: #2980b9; }
        form {
            margin: 30px auto;
            background: #fff;
            padding: 30px 20px;
            border-radius: 12px;
            width: 350px;
            box-shadow: 0px 5px 15px rgba(0,0,0,0.2);
        }
        input, select {
            display: block;
            width: 90%;
            margin: 10px auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            padding: 12px 25px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: 0.3s;
        }
        button:hover { background: #27ae60; }
        #message {
            margin-top: 15px;
            font-weight: bold;
            color: #e74c3c;
        }
        table {
            margin: 30px auto;
            border-collapse: collapse;
            width: 90%;
            max-width: 900px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0px 5px 15px rgba(0,0,0,0.2);
        }
        table th, table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        table th { background: #3498db; color: white; font-size: 16px; }
        table td button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 2px;
        }
        .edit-btn { background: #f39c12; color: white; }
        .edit-btn:hover { background: #e67e22; }
        .delete-btn { background: #e74c3c; color: white; }
        .delete-btn:hover { background: #c0392b; }

        /* Toast styles */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Modal styles */
        #editModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        #editModal div {
            background: #fff; padding: 30px; border-radius: 12px; width: 350px; position: relative;
        }
    </style>
</head>
<body>
    <h1>Welcome to Student Management API</h1>
    <div>
        <a href="/api/students/">Students API</a>
        <a href="/admin/">Admin Panel</a>
    </div>

    <h2>Add a New Student</h2>
    <form id="studentForm">
        <input type="text" id="name" placeholder="Enter name" required>
        <input type="number" id="age" placeholder="Enter age" required>
        <input type="email" id="email" placeholder="Enter email" required>
        <select id="department" required>
            <option value="">Select Department</option>
            <option value="1">CSE</option>
            <option value="2">ECE</option>
            <option value="3">EEE</option>
            <option value="4">MECH</option>
            <option value="5">CIVIL</option>
            <option value="6">IT</option>
            <option value="7">BIO</option>
            <option value="8">CHEM</option>
            <option value="9">AERO</option>
            <option value="10">META</option>
            <option value="11">ARCH</option>
            <option value="12">Kalvium</option>
        </select>
        <select id="course" required>
            <option value="">Select Course</option>
        </select>
        <button type="submit">Add Student</button>
    </form>

    <h2>Student List</h2>
    <table id="studentTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Age</th>
                <th>Email</th>
                <th>Department</th>
                <th>Course</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Edit Student Modal -->
    <div id="editModal">
        <div>
            <h2>Edit Student</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="text" id="editName" placeholder="Enter name" required>
                <input type="number" id="editAge" placeholder="Enter age" required>
                <input type="email" id="editEmail" placeholder="Enter email" required>
                <select id="editDepartment" required>
                    <option value="">Select Department</option>
                    <option value="1">CSE</option>
                    <option value="2">ECE</option>
                    <option value="3">EEE</option>
                    <option value="4">MECH</option>
                    <option value="5">CIVIL</option>
                    <option value="6">IT</option>
                    <option value="7">BIO</option>
                    <option value="8">CHEM</option>
                    <option value="9">AERO</option>
                    <option value="10">META</option>
                    <option value="11">ARCH</option>
                    <option value="12">Kalvium</option>
                </select>
                <select id="editCourse" required>
                    <option value="">Select Course</option>
                </select>
                <button type="submit">Update Student</button>
                <button type="button" style="background:#e74c3c; margin-left:10px;" onclick="closeEditModal()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script>
        function showToast(msg, success=true) {
            let toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.style.backgroundColor = success ? "#2ecc71" : "#e74c3c";
            toast.className = "show";
            setTimeout(() => toast.className = toast.className.replace("show",""), 3000);
        }

        async function loadCourses() {
            try {
                let response = await fetch("/api/courses/");
                let courses = await response.json();
                let courseSelect = document.getElementById("course");
                let editCourseSelect = document.getElementById("editCourse");
                courses.forEach(c => {
                    let option = document.createElement("option");
                    option.value = c.id;
                    option.text = c.name;
                    courseSelect.appendChild(option);
                    let editOption = option.cloneNode(true);
                    editCourseSelect.appendChild(editOption);
                });
            } catch (err) { console.error("Failed to load courses:", err); }
        }

        document.getElementById("studentForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            let studentData = {
                name: document.getElementById("name").value,
                age: document.getElementById("age").value,
                email: document.getElementById("email").value,
                department: document.getElementById("department").value,
                course: document.getElementById("course").value
            };
            try {
                let response = await fetch("/api/students/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify(studentData)
                });
                if (response.ok) {
                    showToast("✅ Student added successfully!");
                    document.getElementById("studentForm").reset();
                    loadStudents();
                } else {
                    let error = await response.json();
                    showToast("❌ Error: "+JSON.stringify(error), false);
                }
            } catch (err) { showToast("⚠️ Something went wrong!", false); }
        });

        async function loadStudents() {
            try {
                let response = await fetch("/api/students/");
                let students = await response.json();
                let tbody = document.querySelector("#studentTable tbody");
                tbody.innerHTML = "";
                students.forEach(s => {
                    let row = `<tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.age}</td>
                        <td>${s.email}</td>
                        <td>${s.department_name}</td>
                        <td>${s.course_name}</td>
                        <td>
                            <button class="edit-btn" onclick="editStudent(${s.id})">✏️</button>
                            <button class="delete-btn" onclick="deleteStudent(${s.id})">❌</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { console.error(err); }
        }

        async function deleteStudent(id) {
            if(!confirm("Are you sure you want to delete this student?")) return;
            try {
                let response = await fetch(`/api/students/${id}/`, {
                    method: "DELETE",
                    headers: { "X-CSRFToken": getCookie("csrftoken") }
                });
                if(response.ok) { showToast("✅ Student deleted successfully!"); loadStudents(); }
                else showToast("❌ Failed to delete student!", false);
            } catch(err) { showToast("⚠️ Something went wrong!", false); }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                document.cookie.split(";").forEach(cookie => {
                    if (cookie.trim().startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.trim().substring(name.length+1));
                    }
                });
            }
            return cookieValue;
        }

        // Edit student modal functions
        function editStudent(id) {
            const student = Array.from(document.querySelectorAll("#studentTable tbody tr"))
                .find(row => row.cells[0].innerText == id);
            document.getElementById("editId").value = id;
            document.getElementById("editName").value = student.cells[1].innerText;
            document.getElementById("editAge").value = student.cells[2].innerText;
            document.getElementById("editEmail").value = student.cells[3].innerText;

            const deptName = student.cells[4].innerText;
            let deptSelect = document.getElementById("editDepartment");
            Array.from(deptSelect.options).forEach(opt => { opt.selected = (opt.text==deptName); });

            const courseName = student.cells[5].innerText;
            let courseSelect = document.getElementById("editCourse");
            Array.from(courseSelect.options).forEach(opt => { opt.selected = (opt.text==courseName); });

            document.getElementById("editModal").style.display = "flex";
        }

        function closeEditModal() { document.getElementById("editModal").style.display = "none"; }

        document.getElementById("editForm").addEventListener("submit", async function(e){
            e.preventDefault();
            let id = document.getElementById("editId").value;
            let studentData = {
                name: document.getElementById("editName").value,
                age: document.getElementById("editAge").value,
                email: document.getElementById("editEmail").value,
                department: document.getElementById("editDepartment").value,
                course: document.getElementById("editCourse").value
            };
            try {
                let response = await fetch(`/api/students/${id}/`, {
                    method:"PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify(studentData)
                });
                if(response.ok) {
                    showToast("✅ Student updated successfully!");
                    closeEditModal();
                    loadStudents();
                } else {
                    let error = await response.json();
                    showToast("❌ Error: "+JSON.stringify(error), false);
                }
            } catch(err) { showToast("⚠️ Something went wrong!", false); }
        });

        // Initial load
        loadCourses();
        loadStudents();
    </script>
</body>
</html>
